<!doctype html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Library UI</title>
    <style>
      :root {
        color-scheme: light dark;
        --bg: #0f1226;
        --text: #e9ecf1;
        --muted: #a6adbb;
        --card: #171a33;
        --border: #2a2f55;
        --primary: #6c5ce7;
        --primary-600: #5a49e4;
        --accent: #00d4ff;
        --danger: #ff5c7a;
        --success: #2dd4bf;
        --shadow: 0 10px 30px rgba(0,0,0,0.25);
      }

      @media (prefers-color-scheme: light) {
        :root {
          --bg: #f6f7fb;
          --text: #0e1320;
          --muted: #5b6472;
          --card: #ffffff;
          --border: #e7e9f0;
          --primary: #6c5ce7;
          --primary-600: #5949e0;
          --accent: #00bcd4;
          --danger: #e91e63;
          --success: #10b981;
          --shadow: 0 10px 30px rgba(17,24,39,0.12);
        }
      }

      body {
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        margin: 0;
        color: var(--text);
        background: radial-gradient(1000px 600px at 20% -10%, rgba(108,92,231,0.25), transparent),
                    radial-gradient(900px 500px at 120% 0%, rgba(0,212,255,0.25), transparent),
                    var(--bg);
        min-height: 100vh;
      }

      .hero {
        background: linear-gradient(120deg, var(--primary), var(--accent));
        color: white;
        padding: 36px 0;
        box-shadow: var(--shadow);
      }

      .container { max-width: 960px; margin: 0 auto; padding: 24px; }
      .hero .container { padding: 0 24px; }

      h1 { margin: 0; font-size: 28px; letter-spacing: 0.3px; }
      .subtitle { margin-top: 6px; opacity: 0.9; font-size: 14px; }

      .surface { margin-top: -28px; }
      .grid { display: grid; grid-template-columns: 1fr; gap: 16px; }
      @media (min-width: 900px) { .grid { grid-template-columns: 1fr; } }

      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 16px;
        box-shadow: var(--shadow);
      }

      .row { display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }

      input {
        padding: 10px 12px;
        font-size: 14px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: transparent;
        color: var(--text);
        outline: none;
        transition: border-color .2s ease, box-shadow .2s ease;
      }
      input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(108,92,231,0.2); }

      .btn {
        padding: 10px 14px; font-size: 14px; cursor: pointer; border-radius: 10px; border: 0;
        display: inline-flex; align-items: center; gap: 8px; transition: transform .06s ease, opacity .2s ease;
      }
      .btn:hover { transform: translateY(-1px); }
      .btn:active { transform: translateY(0); }
      .btn-primary { background: var(--primary); color: #fff; }
      .btn-primary:hover { background: var(--primary-600); }
      .btn-outline { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
      .btn-danger { background: var(--danger); color: #fff; }

      table { width: 100%; border-collapse: collapse; overflow: hidden; border-radius: 12px; }
      thead th { background: linear-gradient(120deg, rgba(108,92,231,0.15), rgba(0,212,255,0.15)); color: var(--text); }
      th, td { border-bottom: 1px solid var(--border); padding: 12px; text-align: left; font-size: 14px; }
      tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }

      .muted { color: var(--muted); font-size: 12px; }
      .error { color: var(--danger); margin-top: 8px; }
      .success { color: var(--success); margin-top: 8px; }

      .footer { text-align: center; margin-top: 24px; color: var(--muted); font-size: 12px; }

      /* Modal (Barcode Scanner) */
      .modal-backdrop {
        position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none;
        align-items: center; justify-content: center; z-index: 1000;
      }
      .modal {
        width: min(92vw, 720px); background: var(--card); border: 1px solid var(--border);
        border-radius: 14px; padding: 16px; box-shadow: var(--shadow);
      }
      .modal-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; }
      .modal-title { font-size: 18px; }
      .modal-actions { display: flex; gap: 8px; }
      .modal-body { display: grid; gap: 10px; }
      .row-inline { display: flex; gap: 8px; align-items: center; }
      select { padding: 8px 10px; border-radius: 10px; border: 1px solid var(--border); background: transparent; color: var(--text); }
      video { width: 100%; border-radius: 10px; background: #000; }
      .hidden { display: none; }
      .video-wrap { position: relative; }
      .guide {
        position: absolute; inset: 0; display: grid; place-items: center; pointer-events: none;
      }
      .guide-rect {
        width: min(80%, 480px); height: 160px; border: 3px solid rgba(255,255,255,0.85);
        box-shadow: 0 0 0 9999px rgba(0,0,0,0.35) inset; border-radius: 12px;
      }
      .code-badge { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.6); color: #fff; padding: 6px 10px; border-radius: 8px; font-size: 13px; }
      .preview-card { border: 1px solid var(--border); border-radius: 10px; padding: 10px; background: var(--card); display: none; }
      .preview-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 8px; }
    </style>
  </head>
  <body>
    <div class="hero">
      <div class="container">
        <h1>üìö K√ºt√ºphane</h1>
        <div class="subtitle">ISBN ile hƒ±zlƒ± ekle, listeden y√∂net. by ƒ∞pek Bulgurcu</div>
      </div>
    </div>

    <div class="container surface">

      <div class="grid">
        <div class="card">
          <div class="row">
            <input id="isbnInput" placeholder="ISBN girin (√∂rn. 9789754341966)" />
            <button id="addBtn" class="btn btn-primary">‚ûï Ekle</button>
            <button id="refreshBtn" class="btn btn-outline">‚Üª Yenile</button>
            <button id="scanBtn" class="btn btn-outline">üì∑ Barkod Tara</button>
          </div>
          <div id="message" class="muted" style="margin-top:8px">ISBN ile ekle: Sunucu Open Library'den ba≈ülƒ±k/yazar bilgilerini alƒ±r.</div>
        </div>

        <div class="card">
          <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 8px; gap:12px;">
            <div class="row" style="flex-wrap: wrap; gap:8px;">
              <button id="deleteSelectedBtn" class="btn btn-danger">üóëÔ∏è Se√ßiliyi Sil</button>
              <input id="searchInput" placeholder="Ara (ba≈ülƒ±k, yazar, ISBN)" style="min-width: 240px;" />
              <select id="sortSelect">
                <option value="title_asc">Ba≈ülƒ±k (A ‚Üí Z)</option>
                <option value="title_desc">Ba≈ülƒ±k (Z ‚Üí A)</option>
                <option value="author_asc">Yazar (A ‚Üí Z)</option>
                <option value="author_desc">Yazar (Z ‚Üí A)</option>
              </select>
            </div>
            <div class="muted"><input type="checkbox" id="selectAllChk" /> Hepsini se√ß</div>
          </div>
          <table>
            <thead>
              <tr>
                <th></th>
                <th>ISBN</th>
                <th>Ba≈ülƒ±k</th>
                <th>Yazar</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="booksBody"></tbody>
          </table>
        </div>
      </div>

      <div class="footer">API: <code>GET /books</code> ¬∑ <code>POST /books</code> ¬∑ <code>DELETE /books/{isbn}</code></div>
    </div>

    <!-- Scanner Modal -->
    <div id="scannerBackdrop" class="modal-backdrop">
      <div class="modal">
        <div class="modal-header">
          <div class="modal-title">üì∑ Barkod Tarayƒ±cƒ±</div>
          <div class="modal-actions">
            <button id="closeScannerBtn" class="btn btn-outline">Kapat</button>
          </div>
        </div>
        <div class="modal-body">
          <div class="muted">Kameraya eri≈üim izni verin. Adres √ßubuƒüundaki kamera ikonundan ‚Äúƒ∞zin ver‚Äù se√ßin. ISBN barkodunu (EAN‚Äë13) kameraya g√∂sterin.</div>
          <div class="row-inline">
            <label for="cameraSelect" class="muted">Kamera:</label>
            <select id="cameraSelect"></select>
          </div>
          <div class="video-wrap">
            <video id="scannerVideo" autoplay playsinline muted></video>
            <div class="guide">
              <div class="guide-rect"></div>
              <div id="codeBadge" class="code-badge hidden"></div>
            </div>
          </div>
          <div id="scannerInfo" class="muted"></div>
          <div id="previewCard" class="preview-card">
            <div id="previewText"></div>
            <div class="preview-actions">
              <button id="confirmAddBtn" class="btn btn-primary">Ekle</button>
              <button id="cancelAddBtn" class="btn btn-outline">ƒ∞ptal</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const booksBody = document.getElementById('booksBody');
      const isbnInput = document.getElementById('isbnInput');
      const addBtn = document.getElementById('addBtn');
      const refreshBtn = document.getElementById('refreshBtn');
      const messageEl = document.getElementById('message');
      const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
      const selectAllChk = document.getElementById('selectAllChk');
      const scanBtn = document.getElementById('scanBtn');
      const scannerBackdrop = document.getElementById('scannerBackdrop');
      const closeScannerBtn = document.getElementById('closeScannerBtn');
      const scannerVideo = document.getElementById('scannerVideo');
      const scannerInfo = document.getElementById('scannerInfo');
      let mediaStream = null;
      let scanning = false;
      let detectedOnce = false;
      const cameraSelect = document.getElementById('cameraSelect');
      let lastDetectedIsbn = '';
      const codeBadge = document.getElementById('codeBadge');
      const previewCard = document.getElementById('previewCard');
      const previewText = document.getElementById('previewText');
      const confirmAddBtn = document.getElementById('confirmAddBtn');
      const cancelAddBtn = document.getElementById('cancelAddBtn');
      let usingZXing = false;
      let zxingReader = null;

      function setMessage(text, kind = 'info') {
        messageEl.textContent = text;
        messageEl.className = kind === 'error' ? 'error' : (kind === 'success' ? 'success' : 'muted');
      }

      async function fetchBooks() {
        setMessage('Y√ºkleniyor...');
        try {
          const res = await fetch('/books');
          if (!res.ok) throw new Error('Liste alƒ±namadƒ±');
          const data = await res.json();
          renderBooks(data);
          setMessage('Liste g√ºncel.');
        } catch (e) {
          setMessage('Hata: ' + (e && e.message ? e.message : e), 'error');
        }
      }

      function filteredAndSortedBooks(allBooks) {
        const q = (document.getElementById('searchInput').value || '').toLowerCase();
        const sort = document.getElementById('sortSelect').value;
        let arr = allBooks.slice();
        if (q) {
          arr = arr.filter(b =>
            (b.title || '').toLowerCase().includes(q) ||
            (b.author || '').toLowerCase().includes(q) ||
            (b.isbn || '').toLowerCase().includes(q)
          );
        }
        const cmpStr = (a,b) => a.localeCompare(b, 'tr', { sensitivity: 'base' });
        if (sort === 'title_asc') arr.sort((a,b)=> cmpStr(a.title||'', b.title||''));
        else if (sort === 'title_desc') arr.sort((a,b)=> cmpStr(b.title||'', a.title||''));
        else if (sort === 'author_asc') arr.sort((a,b)=> cmpStr(a.author||'', b.author||''));
        else if (sort === 'author_desc') arr.sort((a,b)=> cmpStr(b.author||'', a.author||''));
        return arr;
      }

      function renderBooks(allBooks) {
        const books = filteredAndSortedBooks(allBooks);
        booksBody.innerHTML = '';
        if (!books || books.length === 0) {
          const tr = document.createElement('tr');
          const td = document.createElement('td');
          td.colSpan = 5;
          td.textContent = 'Kayƒ±t yok';
          tr.appendChild(td);
          booksBody.appendChild(tr);
          return;
        }
        for (const b of books) {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><input type="checkbox" class="rowChk" data-isbn="${b.isbn}" /></td>
            <td>${b.isbn}</td>
            <td>${b.title}</td>
            <td>${b.author}</td>
            <td><button data-isbn="${b.isbn}" class="delBtn">Sil</button></td>
          `;
          booksBody.appendChild(tr);
        }
        document.querySelectorAll('.delBtn').forEach(btn => {
          btn.addEventListener('click', async (ev) => {
            const isbn = ev.target.getAttribute('data-isbn');
            await deleteBook(isbn);
          });
        });
        document.querySelectorAll('.rowChk').forEach(chk => {
          chk.addEventListener('change', syncHeaderCheckbox);
        });
        syncHeaderCheckbox();
      }

      async function addBook() {
        const isbn = isbnInput.value.trim();
        if (!isbn) { setMessage('ISBN giriniz.', 'error'); return; }
        setMessage('Ekleniyor...');
        try {
          const res = await fetch('/books', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isbn })
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Ekleme ba≈üarƒ±sƒ±z');
          }
          isbnInput.value = '';
          setMessage('Kitap eklendi.', 'success');
          await fetchBooks();
        } catch (e) {
          setMessage('Hata: ' + (e && e.message ? e.message : e), 'error');
        }
      }

      async function deleteBook(isbn) {
        setMessage('Siliniyor...');
        try {
          const res = await fetch(`/books/${encodeURIComponent(isbn)}`, { method: 'DELETE' });
          if (res.status !== 204) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Silme ba≈üarƒ±sƒ±z');
          }
          setMessage('Silindi.', 'success');
          await fetchBooks();
        } catch (e) {
          setMessage('Hata: ' + (e && e.message ? e.message : e), 'error');
        }
      }

      function getSelectedIsbns() {
        return Array.from(document.querySelectorAll('.rowChk'))
          .filter(chk => chk.checked)
          .map(chk => chk.getAttribute('data-isbn'));
      }

      function syncHeaderCheckbox() {
        const checks = Array.from(document.querySelectorAll('.rowChk'));
        if (checks.length === 0) { selectAllChk.checked = false; selectAllChk.indeterminate = false; return; }
        const checked = checks.filter(c => c.checked).length;
        selectAllChk.checked = checked === checks.length;
        selectAllChk.indeterminate = checked > 0 && checked < checks.length;
      }

      async function deleteSelected() {
        const isbns = getSelectedIsbns();
        if (isbns.length === 0) { setMessage('Hi√ß se√ßim yok.', 'error'); return; }
        setMessage('Toplu siliniyor...');
        try {
          const res = await fetch('/books', {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ isbns })
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.detail || 'Toplu silme ba≈üarƒ±sƒ±z');
          }
          const result = await res.json();
          const nf = (result && result.not_found) || [];
          if (nf.length > 0) {
            setMessage(`Silindi: ${isbns.length - nf.length}, Bulunamadƒ±: ${nf.length}`, 'error');
          } else {
            setMessage(`Silindi: ${isbns.length}`, 'success');
          }
          await fetchBooks();
        } catch (e) {
          setMessage('Hata: ' + (e && e.message ? e.message : e), 'error');
        }
      }

      // ===== Barcode Scanner (BarcodeDetector API) =====
      function openScannerModal() {
        scannerBackdrop.style.display = 'flex';
        scannerInfo.textContent = '';
        detectedOnce = false;
        ensurePermissionThenInit();
      }

      function closeScannerModal() {
        scannerBackdrop.style.display = 'none';
        stopScanner();
      }

      async function ensurePermissionThenInit() {
        try {
          // Prompt permission early so we can read device labels
          await navigator.mediaDevices.getUserMedia({ video: true });
        } catch (e) {
          // ignore; user may allow on next attempt
        }
        await listCameras();
        await startScanner();
      }

      async function listCameras() {
        try {
          const devices = await navigator.mediaDevices.enumerateDevices();
          const cams = devices.filter(d => d.kind === 'videoinput');
          cameraSelect.innerHTML = '';
          for (const cam of cams) {
            const opt = document.createElement('option');
            opt.value = cam.deviceId;
            opt.textContent = cam.label || `Kamera ${cameraSelect.length + 1}`;
            cameraSelect.appendChild(opt);
          }
        } catch (e) {
          // best effort
        }
      }

      function buildConstraints() {
        const selected = cameraSelect && cameraSelect.value ? cameraSelect.value : null;
        if (selected) {
          return { video: { deviceId: { exact: selected } } };
        }
        return { video: { facingMode: { ideal: 'environment' } } };
      }

      async function startScanner() {
        try {
          if (!('BarcodeDetector' in window)) {
            // Fallback: ZXing k√ºt√ºphanesini dinamik y√ºkle ve taramayƒ± ba≈ülat
            usingZXing = true;
            await startZXing();
            return;
          }

          let constraints = buildConstraints();
          try {
            mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
          } catch (e) {
            // fallback to any camera
            constraints = { video: true };
            mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
          }
          scannerVideo.srcObject = mediaStream;
          await scannerVideo.play();

          const detector = new BarcodeDetector({ formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128', 'itf'] });
          scanning = true;

          async function tick() {
            if (!scanning) return;
            try {
              const codes = await detector.detect(scannerVideo);
              if (codes && codes.length > 0 && !detectedOnce) {
                detectedOnce = true;
                const raw = (codes[0].rawValue || '').toString();
                const digits = raw.replace(/[^0-9Xx]/g, '');
                onCodeDetected(digits);
              }
            } catch (e) {
              // sessizce ilerle
            }
            requestAnimationFrame(tick);
          }
          requestAnimationFrame(tick);
        } catch (err) {
          scannerInfo.textContent = 'Kameraya eri≈üilemedi: ' + (err && err.message ? err.message : err);
        }
      }

      function stopScanner() {
        scanning = false;
        if (mediaStream) {
          mediaStream.getTracks().forEach(t => t.stop());
          mediaStream = null;
        }
        scannerVideo.srcObject = null;
        if (usingZXing && zxingReader) {
          try { zxingReader.reset(); } catch (_) {}
        }
      }

      addBtn.addEventListener('click', addBook);
      refreshBtn.addEventListener('click', fetchBooks);
      deleteSelectedBtn.addEventListener('click', deleteSelected);
      selectAllChk.addEventListener('change', () => {
        const checked = selectAllChk.checked;
        document.querySelectorAll('.rowChk').forEach(chk => { chk.checked = checked; });
        syncHeaderCheckbox();
      });
      scanBtn.addEventListener('click', openScannerModal);
      closeScannerBtn.addEventListener('click', closeScannerModal);
      cameraSelect.addEventListener('change', async () => { stopScanner(); await startScanner(); });
      scannerBackdrop.addEventListener('click', (e) => { if (e.target === scannerBackdrop) closeScannerModal(); });
      window.addEventListener('DOMContentLoaded', fetchBooks);
      document.getElementById('searchInput').addEventListener('input', async ()=>{ try{ const res=await fetch('/books'); renderBooks(await res.json()); }catch{}});
      document.getElementById('sortSelect').addEventListener('change', async ()=>{ try{ const res=await fetch('/books'); renderBooks(await res.json()); }catch{}});

      // ===== ZXing fallback (dynamic loader) =====
      function loadZXing() {
        return new Promise((resolve, reject) => {
          if (window.ZXing) { resolve(); return; }
          const s = document.createElement('script');
          s.src = 'https://unpkg.com/@zxing/library@0.20.0/umd/index.min.js';
          s.onload = () => resolve();
          s.onerror = () => reject(new Error('ZXing y√ºklenemedi'));
          document.head.appendChild(s);
        });
      }

      async function startZXing() {
        try {
          await loadZXing();
          const ZX = window.ZXing;
          zxingReader = new ZX.BrowserMultiFormatReader();
          const deviceId = cameraSelect && cameraSelect.value ? cameraSelect.value : undefined;
          scanning = true;
          await zxingReader.decodeFromVideoDevice(
            deviceId,
            scannerVideo,
            (result, err) => {
              if (!scanning) return;
              if (result && !detectedOnce) {
                detectedOnce = true;
                const text = (result.text) ? result.text : (result.getText ? result.getText() : '');
                const digits = String(text).replace(/[^0-9Xx]/g, '');
                onCodeDetected(digits);
              }
            }
          );
        } catch (e) {
          scannerInfo.textContent = 'ZXing ba≈ülatƒ±lamadƒ±: ' + (e && e.message ? e.message : e);
        }
      }

      // Confirm / Cancel handlers for preview add
      confirmAddBtn.addEventListener('click', async () => {
        if (!lastDetectedIsbn) return;
        isbnInput.value = lastDetectedIsbn;
        try {
          await addBook();
          previewCard.style.display = 'none';
          codeBadge.classList.add('hidden');
          closeScannerModal();
        } catch (_) {}
      });
      cancelAddBtn.addEventListener('click', () => {
        previewCard.style.display = 'none';
        codeBadge.classList.add('hidden');
        detectedOnce = false; // yeniden denemeye izin ver
        scannerInfo.textContent = 'Tekrar deneyin.';
      });

      async function onCodeDetected(digits) {
        codeBadge.classList.remove('hidden');
        codeBadge.textContent = `Kod: ${digits}`;
        if (digits.length < 10) return;
        lastDetectedIsbn = digits;
        scannerInfo.textContent = '√ñnizleme getiriliyor...';
        try {
          const res = await fetch(`/books/preview/${encodeURIComponent(digits)}`);
          if (!res.ok) throw new Error('√ñnizleme alƒ±namadƒ±');
          const book = await res.json();
          previewText.textContent = `${book.title} ‚Äî ${book.author} (ISBN: ${book.isbn})`;
          previewCard.style.display = 'block';
          scannerInfo.textContent = 'Onaylarsanƒ±z eklenecek.';
        } catch (e) {
          previewCard.style.display = 'none';
          scannerInfo.textContent = 'Hata: ' + (e && e.message ? e.message : e);
        }
      }
    </script>
  </body>
</html>



